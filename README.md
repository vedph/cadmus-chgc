# Cadmus CHGC Core

Components specific to the Cadmus CHGC Project.

- [API](https://github.com/vedph/cadmus-chgc-api)
- [app](https://github.com/vedph/cadmus-chgc-app)

This project uses Cadmus only as a mean of annotating images with an additional set of essential metadata. So, the only project-specific component is the `ChgcImageAnnotationsPart` part.

## ChgcImageAnnotationsPart

ID: `it.vedph.chgc.image-annotations`

- annotations (`ChgcImageAnnotation[]`):
  - id\* (`string`): this ID is a GUID automatically generated for each annotation.
  - target\* (`GalleryImage`):
    - id\* (`string`)
    - uri\* (`string`)
    - title\* (`string`)
    - description (`string`)
  - selector\* (`string`)
  - eid\* (`string`, thesaurus `chgc-ids`): the CHGC ID.
  - label (`string`)
  - note (`string`)

## CLI

The CLI tool is a multiple-platform, command-line based tool used to export TEI from a CHGC Cadmus database. This is work in progress; currently the only command is `build-tei` to build one or more TEI documents from scratch. The tool can run in Windows, MacOS, and most Linux flavors.

>The import area of this project workflow (=[importing thesauri](https://github.com/vedph/cadmus_tool#thesaurus-import-command) of IDs from Excel/CSV/plain text) is covered by the [generic Cadmus CLI tool](https://github.com/vedph/cadmus_tool).

### Build TEI Command

ðŸŽ¯ Build and/or patch TEI documents from a CHGC database. If a TEI document exists, it will be updated. Otherwise, a new one will be created.

Syntax:

```ps1
./chgc build-tei <OutputDirectory> [-d <DatabaseName>] [-g <GroupId>]
```

- `-d` (or `--database`): the source database name (default = `cadmus-chgc`).
- `-g` (or `--group`): the group ID to limit extraction to. When not specified, all the groups will be exported. Each group corresponds to a manuscript, and each manuscript corresponds to a TEI file.

Example:

```ps1
./chgc build-tei c:/users/dfusi/desktop/out -g ms-a
```

A new TEI file is generated for each manuscript (group ID). So, with relation to the Cadmus database, we are exporting items grouped by their groups. In turn, each item usually includes an images annotations part. When this is not present, the item is not exported; otherwise, the contents of this part are used to populate the TEI output.

Each TEI document is named after its group ID (=manuscript ID). Its header is somewhat fixed, except for some trivial data like current year. As for the `text` element, it is structured as follows:

(1) **zones**, one for each annotation in a `TEI/text/facsimile` element, with the following template. In this template:

- `ITEM_GUID` = the Cadmus item's GUID, used as the page identifier, e.g. `661f0266-43ee-45ab-93bf-008b26ed498b`.
- `IMAGE_HID` = the human-friendly image ID, like e.g. `ccc-ms029/1`, built with:
  - manuscript ID;
  - `/`;
  - image ordinal number in its IIIF source.
- `IMAGE_URI`: the source image URI.
- `ANNOTATION_ID`: the annotation GUID (without the initial `#`, which is included in the GUID generated by Recogito Annotorious library), e.g. `36c9730c-a7c9-4a28-8889-8d6015ee14fe`.
- `ENTITY_ID`: the ID of the entity picked from the project's authority list, e.g. `n-aaron`.
- `GEOMETRY_ATTRIBUTES` are attributes which vary according to the geometry of the drawn shape (see below).
- `SVG` is the SVG code, produced by Annotorious or supplied by the exporter for rectangular shapes and polygons.

```xml
<facsimile>
  <!-- begin for each image -->
  <surface xml:id="ITEM_GUID"
           n="IMAGE_HID"
           source="IMAGE_URI">
    <!-- begin for each annotation in the image -->
    <zone xml:id="ANNOTATION_ID"
          n="IMAGE_HID/ENTITY_ID"
          GEOMETRY_ATTRIBUTES>
      <svg xmlns="http://www.w3.org/2000/svg">
        SVG
      </svg>
    </zone>
    <!-- end for each annotation in the image -->
  </surface>
  <!-- end for each image -->
</facsimile>
```

here, `geometry-attributes` are:

- **rectangle**: attributes `ulx`, `uly`, `lrx`, `lry`.
- **polygon**: attribute `points` with a pair of `X,Y` coordinates (separated by comma), where pairs are separated by space.
- **circle**: output its bounding rectangle attributes.
- **ellipse**: output its bounding rectangle attributes.
- **freehand**: just the SVG content. A bounding rectangle here would require too much work to parse the SVG path minilanguage and do the corresponding calculations, whereas bounding rectangles are just a way for gracefully downgrade data in case of clients not able to deal with SVG. At any rate, freehand shapes are likely to be very rare, or just never be used.

(2) **pages**, in the `TEI/text/body` element, with this template:

```xml
<body>
  <!-- begin for each image -->
  <pb xml:id="ITEM_ID"
      n="IMAGE_HID"/>
  <!-- a div for each annotation, merged if sharing the same ENTITY_ID; type is node, text, diagram, picture, group, connection -->
  <div xml:id="ANNOTATION_ID ..."
       type="node"
       corresp="#ENTITY_ID"
       facs="#IMAGE_HID/ENTITY_ID ...">
      <!-- these elements are output only if their placeholder is defined -->
      <label>...</label>
      <note>...</note>
  </div>
  <!-- end for each image -->
</body>
```

A sample output follows, from a single item (page) having 3 annotations, 2 of them sharing the same entity ID (`n-aaron`):

```xml
<TEI xmlns="http://www.tei-c.org/ns/1.0">
  <teiHeader>
    <fileDesc>
      <titleStmt>
        <title type="main">Compendium Historiae in genealogia Christi</title>
        <title type="sub">Electronic transcription of the manuscript </title>
        <author>Petrus von Poitiers<ex>Petrus Pictaviensis</ex></author>
        <respStmt>
          <resp>edited by</resp>
          <persName ref="#" />
        </respStmt>
      </titleStmt>
      <publicationStmt>
        <publisher>
          <orgName corresp="https://kunstgeschichte.unigraz.at">Institut fÃ¼r Kunstgeschichte, Karl-Franzens-UniversitÃ¤t Graz</orgName>
        </publisher>
        <authority>
          <orgName corresp="https://informationsmodellierung.unigraz.at">Zentrum fÃ¼r Informationsmodellierung - Austrian Centre for Digital Humanities, Karl-Franzens-UniversitÃ¤t Graz</orgName>
        </authority>
        <distributor>
          <orgName ref="https://gams.uni-graz.at">GAMS - Geisteswissenschaftliches Asset Management System</orgName>
        </distributor>
        <availability>
          <licence target="https://creativecommons.org/licenses/by-ncsa/4.0">Creative Commons BY-NC-SA 4.0</licence>
        </availability>
        <date>2023</date>
        <pubPlace>Graz</pubPlace>
      </publicationStmt>
      <sourceDesc>
        <p />
      </sourceDesc>
    </fileDesc>
  </teiHeader>
  <facsimile>
    <surface xml:id="661f0266-43ee-45ab-93bf-008b26ed498b" n="ccc-ms029/1" source="http://img.org/1r.jpg">
      <zone xml:id="36c9730c-a7c9-4a28-8889-8d6015ee14fe" n="ccc-ms029/1/n-aaron-01" ulx="100" uly="50" lrx="230" lry="120">
        <svg x="100" y="50" width="130" height="70" xmlns="http://www.w3.org/2000/svg " />
      </zone>
      <zone xml:id="faec7d03-8010-407f-8689-a38cf35505ab" n="ccc-ms029/1/n-aaron-02" ulx="300" uly="100" lrx="620" lry="220">
        <svg x="300" y="100" width="320" height="120" xmlns="http://www.w3.org/2000/svg " />
      </zone>
      <zone xml:id="af35f367-a921-4af3-bb84-4911cbc82a53" n="ccc-ms029/1/n-abacuc" ulx="350" uly="150" lrx="450" lry="250">
        <svg xmlns="http://www.w3.org/2000/svg">
          <circle cx="400" cy="200" r="50" />
        </svg>
      </zone>
    </surface>
  </facsimile>
  <text>
    <body>
      <pb xml:id="661f0266-43ee-45ab-93bf-008b26ed498b" n="ccc-ms029/1" />
      <div xml:id="36c9730c-a7c9-4a28-8889-8d6015ee14fe faec7d03-8010-407f-8689-a38cf35505ab" type="node" corresp="#n-aaron" facs="#ccc-ms029/1/n-aaron-01 #ccc-ms029/1/n-aaron-02">
        <label>Aaron</label>
      </div>
      <div xml:id="af35f367-a921-4af3-bb84-4911cbc82a53" type="node" corresp="#n-abacuc" facs="#ccc-ms029/1/n-abacuc">
        <label>Abacuc</label>
      </div>
    </body>
  </text>
</TEI>
```

### Import TEI Command

ðŸŽ¯ Import TEI documents into a CHGC database, where each document contains a `TEI/facsimile` element including as many `surface` elements as the pages to import. This is used to create in advance the items representing all the pages of a given manuscript, each TEI document corresponding to a single manuscript.

It is assumed that the TEI file name is equal to the manuscript ID; this will become the group ID of the imported items.

For each `surface` element, an item will be created with these data:

- facet ID = "image";
- group ID = the TEI file name (without extension);
- title = group ID + page ordinal number + `@n` attribute value";
- description = `@n` attribute value: image uri;
- flags = 1 (=imported);
- creator ID and user ID = `zeus`;
- an empty CHGC image annotations part with the corresponding target image.

Syntax:

```ps1
./chgc import-tei <InputFileMask> [-d <DatabaseName>] [-p <UriShortenerPattern>]
```

- `-d` (or `--database`): the target database name (default = `cadmus-chgc`);
- `-p` (or `--pattern`): the regular expression pattern to use to shorten the URI for using it in the imported item's description. If not specified, the URI will be copied as is; else, it will be shortened by replacing it with the _first group_ of the match.

Example:

```ps1
./chgc import-tei c:/users/dfusi/desktop/ccc-ms029.xml -p "^https:\/\/stacks\.stanford\.edu\/image\/iiif\/xj710dc7305\/([^\/]+).+"
```

In this example, the pattern is designed for URIs like this:

```txt
https://stacks.stanford.edu/image/iiif/xj710dc7305/029_vi_R_TC_46/full/1024,/0/default.jpg
```

In this case, the first group of the match will be `029_vi_R_TC_46`, which will be used as the shortened URI.

Example `facsimile` element:

```xml
<facsimile>
  <surface n="6r" source="https://stacks.stanford.edu/image/iiif/xj710dc7305/029_vi_R_TC_46/full/full/0/default.jpg"> 
  </surface>
  <surface n="6v" source="https://stacks.stanford.edu/image/iiif/xj710dc7305/029_vi_V_TC_46/full/full/0/default.jpg"/>
  <surface n="7r" source="https://stacks.stanford.edu/image/iiif/xj710dc7305/029_vii_R_TC_46/full/full/0/default.jpg"/>
  <surface n="7v" source="https://stacks.stanford.edu/image/iiif/xj710dc7305/029_vii_V_TC_46/full/full/0/default.jpg"/>
  <surface n="8r" source="https://stacks.stanford.edu/image/iiif/xj710dc7305/029_viii_R_TC_46/full/full/0/default.jpg"/>
  <surface n="8v" source="https://stacks.stanford.edu/image/iiif/xj710dc7305/029_viii_V_TC_46/full/full/0/default.jpg"/>
  <surface n="9r" source="https://stacks.stanford.edu/image/iiif/xj710dc7305/029_ix_R_TC_46/full/full/0/default.jpg"/>
  <surface n="9v" source="https://stacks.stanford.edu/image/iiif/xj710dc7305/029_ix_V_TC_46/full/full/0/default.jpg"/>
  <surface n="10r" source="https://stacks.stanford.edu/image/iiif/xj710dc7305/029_x_R_TC_46/full/full/0/default.jpg"/>
  <surface n="10v" source="https://stacks.stanford.edu/image/iiif/xj710dc7305/029_x_V_TC_46/full/full/0/default.jpg"/>
  <surface n="11r" source="https://stacks.stanford.edu/image/iiif/xj710dc7305/029_xi_R_TC_46/full/full/0/default.jpg"/>
</facsimile>
```

## History

- 2023-08-08: added `a-` and `i-` prefixes to IDs in XML.

### 2.1.3

- 2023-08-06:
  - updated packages.
  - removed `#` from `xml:id`.

### 2.1.2

- 2023-08-01: fixes to supplied SVG in export.

### 2.1.0

- 2023-07-28: refactoring XML output schema.

### 2.0.3

- 2023-07-18:
  - added `image` to CHGC image annotations part.
  - added importer.
- 2023-07-14: breaking changes: refactored imaging parts. This just implies that now the CHGC image annotation model no more has the (unused but previously inherited) `Notes` and `Tags` properties.

### 1.1.5

- 2023-07-07: sorted insert.
- 2023-07-06:
  - added svg child element to zone.
  - added numeric suffixes to image identifiers with the same entity ID.

### 1.1.4

- 2023-07-06: fixed culture in numeric parsing for selectors.

### 1.1.3

- 2023-07-01: added RAM-based item composer.
- 2023-06-29:
  - added `source` attribute.
  - adapted `FSChgcTeiItemComposer` for patching.
- 2023-06-24: adding export library.

### 1.1.2

- 2023-06-23: updated packages.

### 1.1.0

- 20233-06-17: refactored part model.

### 1.0.1

- 2023-06-02: updated packages.

### 1.0.0

- 2023-05-24: updated packages (breaking change in general parts introducing [AssertedCompositeId](https://github.com/vedph/cadmus-bricks-shell/blob/master/projects/myrmidon/cadmus-refs-asserted-ids/README.md#asserted-composite-id)).
